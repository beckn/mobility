# How to build the specification

**Note:** All folders mentioned here are relative to the api folder ``mobility/api``

The full specification can be found at `mobility/build/mobility.yaml`

This is an autogenerated file created by compiling two sets of components namely,

1. APIs : found at `mobility/components/io/`
2. Schema : found at `mobility/components/schemas/`

The compilation flow is illustrated below

# Compilation steps

## Step 1 : Create the schema index file

- Go to the ``mobility/components/schemas/`` folder
- Create a file ``index.yaml``. If already present, open it in a text editor
- It will contain a list of schema with $refs pointing to specific schema files in the ``schema/`` folder as shown below

```
Ack:
  $ref: "../../../../Ack.yaml"
  
AddOn:
  $ref: "../../../../AddOn.yaml"
...
```

- Ensure that each file in the ``schemas`` folder has an entry in this file. If it is not present, it will not be compiled

## Step 2 : Create the unresolved OpenAPI file

- Go to the `mobility/components/` folder
- In this folder, create a file - `mobility-un.yaml`. If it is already present, open it in a text editor.
- In the file, you will see the following

```
openapi: 3.0.0
info:
  title: Beckn Mobility API Specification
  description: Adaptation of beckn protocol for the mobility sector. Compatible with core version 0.9.4 LTS. 
  version: 0.8.0
security:
  - SubscriberAuth: []
  - GatewaySubscriberAuth: []
  - GatewaySubscriberAuthNew: []
paths:
  /search:
    post:
      tags:
        - Beckn Provider Platform (BPP)
        - Beckn Gateway (BG)
      description: BAP declares the customer's intent to buy/avail products or services
      requestBody:
        content:
          application/json:
            schema:
              $ref : "./io/Search.yaml"
            examples:
              example0:
                $ref: '#/components/examples/search_example_0'
              example1:
                $ref: '#/components/examples/search_example_0'

      responses:
        default:
          $ref: "./io/Response.yaml"
....
```

- As you can see, the ``mobility/components/mobility-unresolved.yaml`` contains the unresolved Open API definitions with references to the schemas found in ``mobility/components/io/``
- Ensure each API definition in the ``mobility/components/io/`` folder is referenced in this file. If it is not present, it will not be compiled.
- Once all API referencing is done, save this file and close it.

## Install swagger CLI

- Install the swagger command line tool using ``npm`` (Note: you may need to use root privileges if installing it globally)

```
sudo npm install -g swagger-cli
```

## Generate the resolved OpenAPI definition file

- Go to the `api/` directory of this project
  ```
  cd api/
  ```
- Run the following command

```
swagger-cli bundle mobility/components/mobility-unresolved.yaml --outfile mobility/build/mobility.yaml --type yaml
```

- If the command runs successfully, you should see an output like this,

```
Created mobility/build/mobility.yaml from mobility/build/mobility.yaml
```

- Commit the changes and push the updated code
